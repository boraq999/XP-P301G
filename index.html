<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµØ§Ù…ØªØ© - App1</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .online {
            background: #dcfce7;
            color: #166534;
        }

        .offline {
            background: #fee2e2;
            color: #991b1b;
        }

        #invoice-container {
            background: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            width: 350px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠ */
        #invoice-to-print {
            width: 272px;
            /* 80mm approx */
            margin: 0 auto;
            background: #fff;
            color: #000;
        }

        .inv-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .inv-title {
            background: #000;
            color: #fff;
            padding: 5px;
            display: inline-block;
        }

        .inv-line {
            border-top: 1px dotted #000;
            margin: 10px 0;
        }

        .inv-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin: 3px 0;
        }

        .inv-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .inv-table th {
            border-bottom: 1px solid #000;
            font-size: 12px;
            padding-bottom: 5px;
        }

        .inv-table td {
            font-size: 14px;
            padding: 5px 0;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ ÙŠØ­Ø§ÙƒÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ØªÙ…Ø§Ù…Ø§Ù‹ (Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©) */
        #bluetooth-render-area {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 560px;
            /* Ù†ÙØ³ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ± */
            background: white;
            color: black;
            padding: 20px;
            font-family: "Segoe UI", Arial, sans-serif;
        }

        #bluetooth-render-area .bt-company {
            font-size: 38px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        #bluetooth-render-area .bt-title-box {
            text-align: center;
            margin-bottom: 40px;
        }

        #bluetooth-render-area .bt-title {
            background: #000;
            color: #fff;
            padding: 10px 40px;
            font-size: 34px;
            font-weight: bold;
            display: inline-block;
        }

        #bluetooth-render-area .bt-info {
            font-size: 24px;
            text-align: center;
            margin: 5px 0;
        }

        #bluetooth-render-area .bt-dot-line {
            border-top: 2px dashed #000;
            margin: 20px 0;
        }

        #bluetooth-render-area .bt-solid-line {
            border-top: 3px solid #000;
            margin: 20px 0;
        }

        #bluetooth-render-area .bt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        #bluetooth-render-area .bt-table th {
            font-size: 28px;
            font-weight: bold;
            padding-bottom: 15px;
            text-align: right;
        }

        #bluetooth-render-area .bt-table td {
            font-size: 32px;
            padding: 15px 0;
            font-weight: normal;
        }

        #bluetooth-render-area .bt-total-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        #bluetooth-render-area .bt-total-label {
            font-size: 30px;
        }

        #bluetooth-render-area .bt-total-val {
            font-size: 40px;
            font-weight: bold;
        }

        #bluetooth-render-area .bt-footer {
            text-align: center;
            font-size: 24px;
            margin-top: 50px;
            line-height: 1.6;
        }

        #bluetooth-render-area .bt-table td {
            font-size: 28px;
            padding: 12px 0;
            font-weight: 600;
        }

        #bluetooth-render-area .bt-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            border-top: 2px solid #000;
            padding-top: 15px;
            margin-top: 10px;
        }

        #bluetooth-render-area .bt-total-val {
            font-size: 38px;
            font-weight: 900;
        }

        #bluetooth-render-area .bt-footer {
            text-align: center;
            font-size: 18px;
            margin-top: 30px;
        }

        .btn-print {
            margin-top: 30px;
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-print:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-bluetooth {
            margin-top: 15px;
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-bluetooth:hover {
            background: #0284c7;
            transform: translateY(-2px);
        }

        .btn-text {
            margin-top: 5px;
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-text:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµØ§Ù…ØªØ© (App1)</h1>
        <div id="status" class="status-badge offline">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>
    </div>

    <div id="invoice-container">
        <!-- Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù„Ø§ Ù†Ù„Ù…Ø³Ù‡Ø§) -->
        <div id="invoice-to-print">
            <div class="inv-header">
                <h3>Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙÙˆÙ‚ÙˆÙ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h3>
                <div class="inv-title">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                <p style="font-size:12px">INV-2026/0042<br>2026-02-27</p>
            </div>

            <div class="inv-line"></div>

            <table class="inv-table">
                <thead>
                    <tr>
                        <th style="text-align:right">Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>ÙƒÙ…ÙŠØ©</th>
                        <th style="text-align:left">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align:right">Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ 1</td>
                        <td style="text-align:center">1</td>
                        <td style="text-align:left">10.00</td>
                    </tr>
                    <tr>
                        <td style="text-align:right">Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ 2</td>
                        <td style="text-align:center">3</td>
                        <td style="text-align:left">50.00</td>
                    </tr>
                </tbody>
            </table>

            <div class="inv-line"></div>

            <div class="inv-row">
                <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                <span style="font-weight:bold; font-size:16px;">60.00 Ø¯.Ù„</span>
            </div>

            <div class="inv-header" style="margin-top:20px;">
                <p style="font-size:11px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…<br>ØªØ§Ø¬ Ù…ÙˆÙ„ - Ø·Ø±Ø§Ø¨Ù„Ø³</p>
            </div>
        </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ù†Ø¯Ø±Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ø¨Ù„ÙˆØªÙˆØ« ÙÙ‚Ø· -->
    <div id="bluetooth-render-area"></div>

    <div class="btn-container">
        <button class="btn-print" onclick="printSilently()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØµØ§Ù…ØªØ© (ØµÙˆØ±Ø©)</button>
        <button class="btn-text" onclick="printAsText()">ğŸ”¤ Ø·Ø¨Ø§Ø¹Ø© Ù†ØµÙŠØ© (Ø³Ø±ÙŠØ¹Ø©)</button>
        <button class="btn-bluetooth" onclick="printViaBluetooth()">ğŸ“± Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ø¨Ù„ÙˆØªÙˆØ«</button>
        <button
            style="margin-top:5px; background:#64748b; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;"
            onclick="testEnglishPrint()">ğŸ‡¬ğŸ‡§ Test English Print</button>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:3333';

        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
        async function checkServer() {
            try {
                const res = await fetch(SERVER_URL + '/');
                if (res.ok) {
                    document.getElementById('status').innerText = 'âœ… Ø³ÙŠØ±ÙØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø§Ù‡Ø²';
                    document.getElementById('status').className = 'status-badge online';
                }
            } catch (e) {
                document.getElementById('status').innerText = 'âŒ Ø³ÙŠØ±ÙØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø·ÙØ£';
                document.getElementById('status').className = 'status-badge offline';
            }
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        function testEnglishPrint() {
            const container = document.getElementById('invoice-to-print');
            container.dir = 'ltr';
            container.innerHTML = `
                <div class="inv-header">
                    <h3>ALPHA TECH CO.</h3>
                    <div class="inv-title">SALES INVOICE</div>
                    <p style="font-size:12px">INV-EN-9999<br>2026-02-28</p>
                </div>
                <div class="inv-line"></div>
                <table class="inv-table">
                    <thead>
                        <tr>
                            <th style="text-align:left">Item</th>
                            <th>Qty</th>
                            <th style="text-align:right">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Test Product A</td><td style="text-align:center">2</td><td style="text-align:right">20.00</td></tr>
                        <tr><td>Fast Print Test</td><td style="text-align:center">1</td><td style="text-align:right">50.00</td></tr>
                    </tbody>
                </table>
                <div class="inv-line"></div>
                <div class="inv-row">
                    <span>Grand Total:</span>
                    <span style="font-weight:bold; font-size:16px;">70.00 USD</span>
                </div>
                <div class="inv-header" style="margin-top:20px;">
                    <p style="font-size:11px;">Thank you for your visit<br>Tripoli - Libya</p>
                </div>
            `;
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ±Ø§Ù‹
            setTimeout(printViaBluetooth, 500);
        }

        async function printSilently() {
            const btn = document.querySelector('.btn-print');
            const originalText = btn.innerText;
            btn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            btn.disabled = true;

            try {
                const canvas = await html2canvas(document.getElementById('invoice-to-print'), {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });

                const base64Image = canvas.toDataURL('image/png').split(',')[1];

                const response = await fetch(SERVER_URL + '/print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Image })
                });

                const result = await response.json();
                if (result.success) {
                    alert('âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + result.error);
                }
            } catch (error) {
                alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ local_server.js');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function printAsText() {
            const btn = document.querySelector('.btn-text');
            const originalText = btn.innerText;
            btn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            btn.disabled = true;

            // ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù€ DOM Ù…Ø¨Ø§Ø´Ø±Ø©
            const invoiceData = {
                company: document.querySelector('.inv-header h3')?.innerText || 'Ø´Ø±ÙƒØ©',
                title: document.querySelector('.inv-title')?.innerText || 'ÙØ§ØªÙˆØ±Ø©',
                invoiceNo: document.querySelector('.inv-header p')?.innerHTML?.split('<br>')[0] || '',
                date: document.querySelector('.inv-header p')?.innerHTML?.split('<br>')[1] || '',
                items: [],
                grandTotal: document.querySelector('.inv-row span:last-child')?.innerText || '',
                footer1: document.querySelector('.inv-header:last-of-type p')?.innerHTML?.split('<br>')[0] || '',
                footer2: document.querySelector('.inv-header:last-of-type p')?.innerHTML?.split('<br>')[1] || ''
            };

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„
            document.querySelectorAll('.inv-table tbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    invoiceData.items.push({
                        name: cells[0].innerText,
                        qty: cells[1].innerText,
                        total: cells[2].innerText
                    });
                }
            });

            try {
                const response = await fetch(SERVER_URL + '/print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice: invoiceData })
                });

                const result = await response.json();
                if (result.success) {
                    alert('âœ… ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØµÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + result.error);
                }
            } catch (error) {
                alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        setInterval(checkServer, 3000);
        checkServer();

        // --- Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ø§Ù„ÙØ§Ø¦Ù‚Ø© (Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©) ---
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;

        async function printViaBluetooth() {
            const btn = document.querySelector('.btn-bluetooth');
            const originalText = btn.innerText;
            btn.innerText = 'â³ Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            btn.disabled = true;

            try {
                if (!navigator.bluetooth) { alert('âŒ Ù„Ø§ ÙŠØ¯Ø¹Ù…'); return; }

                // 1. Ø¨Ù†Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø®ÙÙŠØ©
                const renderArea = document.getElementById('bluetooth-render-area');
                const originalInv = document.getElementById('invoice-to-print');

                // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ù†ÙØ³ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­Ø±ÙÙŠØ§Ù‹
                renderArea.innerHTML = `
                    <div class="bt-company">${originalInv.querySelector('h3').innerText}</div>
                    <div class="bt-title-box"><div class="bt-title">${originalInv.querySelector('.inv-title').innerText}</div></div>
                    <div class="bt-info">Ø±Ù‚Ù…: INV-2026/0042</div>
                    <div class="bt-info">ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-LY')}</div>
                    
                    <div class="bt-dot-line"></div>
                    
                    <table class="bt-table">
                        <thead>
                            <tr><th style="text-align:right">Ø§Ù„Ù…Ù†ØªØ¬</th><th style="text-align:center">ÙƒÙ…ÙŠØ©</th><th style="text-align:left">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
                        </thead>
                    </table>
                    <div class="bt-solid-line"></div>
                    <table class="bt-table">
                        <tbody>
                            ${Array.from(originalInv.querySelectorAll('.inv-table tbody tr')).map(tr => `
                                <tr>
                                    <td style="text-align:right; width:50%">${tr.cells[0].innerText}</td>
                                    <td style="text-align:center; width:20%">${tr.cells[1].innerText}</td>
                                    <td style="text-align:left; width:30%">${tr.cells[2].innerText}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="bt-dot-line"></div>
                    
                    <div class="bt-total-section">
                        <span class="bt-total-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                        <span class="bt-total-val">${originalInv.querySelector('.inv-row span:last-child').innerText}</span>
                    </div>
                    
                    <div class="bt-footer">
                        Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… Ù„Ù†Ø§<br>
                        Ø·Ø±Ø§Ø¨Ù„Ø³ - Ù„ÙŠØ¨ÙŠØ§
                    </div>
                `;

                // 2. Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© (Ø¨Ø¹Ø±Ø¶ 384px) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØ¶ÙˆØ­ Ø§Ù„ØªØ§Ù…
                const canvas = await html2canvas(renderArea, {
                    scale: 1, // Ù…Ù‚ÙŠØ§Ø³ 1 ÙƒØ§ÙÙ Ø¬Ø¯Ø§Ù‹ Ù„Ø£Ù† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠØ© 384px
                    backgroundColor: '#ffffff'
                });

                const rasterData = canvasToRaster(canvas);

                if (!bluetoothDevice || !bluetoothDevice.gatt.connected) {
                    btn.innerText = 'â³ ØªÙˆØµÙŠÙ„...';
                    bluetoothDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }],
                        optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
                    });
                    const server = await bluetoothDevice.gatt.connect();
                    const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                    bluetoothCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                }

                btn.innerText = 'â³ Ø¥Ø±Ø³Ø§Ù„...';
                await sendInChunks(bluetoothCharacteristic, rasterData);
                alert('âœ… ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ø«Ø§Ù„ÙŠØ©!');

            } catch (error) {
                console.error(error);
                alert('âŒ Ø®Ø·Ø£: ' + error.message);
                bluetoothDevice = null;
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function canvasToRaster(canvas) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const imageData = ctx.getImageData(0, 0, width, height).data;

            // --- Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø°ÙƒÙŠ: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ---
            let lastUsedRow = height;
            for (let y = height - 1; y >= 0; y--) {
                let hasData = false;
                for (let x = 0; x < width; x++) {
                    const idx = (y * width + x) * 4;
                    if (imageData[idx + 3] > 0 && imageData[idx] < 220) { hasData = true; break; }
                }
                if (hasData) { lastUsedRow = y + 20; break; }
            }
            if (lastUsedRow > height) lastUsedRow = height;

            const widthBytes = Math.ceil(width / 8);
            const raster = [];

            // ØªÙ‡ÙŠØ¦Ø© ÙˆØ£Ù…Ø± Ø§Ù„ØµÙˆØ±Ø©
            raster.push(0x1B, 0x40); // Reset
            raster.push(0x1D, 0x76, 0x30, 0x00);
            raster.push(widthBytes & 0xFF, (widthBytes >> 8) & 0xFF);
            raster.push(lastUsedRow & 0xFF, (lastUsedRow >> 8) & 0xFF);

            for (let y = 0; y < lastUsedRow; y++) {
                for (let x = 0; x < widthBytes; x++) {
                    let byte = 0;
                    for (let bit = 0; bit < 8; bit++) {
                        const xPos = x * 8 + bit;
                        if (xPos < width) {
                            const idx = (y * width + xPos) * 4;
                            const br = (imageData[idx] * 0.299 + imageData[idx + 1] * 0.587 + imageData[idx + 2] * 0.114);
                            if (imageData[idx + 3] > 128 && br < 185) { byte |= (0x80 >> bit); }
                        }
                    }
                    raster.push(byte);
                }
            }
            raster.push(0x1B, 0x64, 0x05, 0x1D, 0x56, 0x00); // Cut
            return new Uint8Array(raster);
        }

        async function sendInChunks(characteristic, data) {
            // 180 Ø¨Ø§ÙŠØª Ù‡Ùˆ Ø§Ù„ØªÙˆØ§Ø²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±
            const CHUNK_SIZE = 180;
            const total = data.length;
            const statusBadge = document.getElementById('status');

            for (let i = 0; i < total; i += CHUNK_SIZE) {
                const chunk = data.slice(i, i + CHUNK_SIZE);

                // Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                if (characteristic.writeValueWithoutResponse) {
                    await characteristic.writeValueWithoutResponse(chunk);
                } else {
                    await characteristic.writeValue(chunk);
                }

                if (i % (CHUNK_SIZE * 10) === 0) {
                    statusBadge.innerText = `âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©: ${Math.round((i / total) * 100)}%`;
                }

                // ØªØ£Ø®ÙŠØ± Ù…Ø¬Ù‡Ø±ÙŠ (1ms) ÙÙ‚Ø· Ù„Ù…Ù†Ø¹ Ø§Ø²Ø¯Ø­Ø§Ù… Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ
                await new Promise(r => setTimeout(r, 1));
            }
            statusBadge.innerText = 'âœ… Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø¬Ø§Ù‡Ø²Ø©';
        }
    </script>
</body>

</html>